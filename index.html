<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Morocco Map - Ports and Provinces</title>
    <!-- Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; padding:0; font-family: Arial, sans-serif; }
        #map { width:100%; height:100vh; }
        #loading { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            background: white; 
            padding: 15px; 
            border-radius: 5px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h3>Loading Morocco Map...</h3>
        <div id="status">Checking data files...</div>
        <div id="file-status"></div>
    </div>
    <div id="map"></div>
    
    <script>
        // Initialize map centered on Morocco
        var map = L.map('map').setView([31.7917, -7.0926], 6);
        
        // Add OpenStreetMap base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Function to load JS files (which contain GeoJSON data as variables)
        function loadJSDataFile(filename, color, layerName) {
            return new Promise((resolve, reject) => {
                // Create a script element to load the JS file
                var script = document.createElement('script');
                script.src = filename;
                script.onload = function() {
                    // The JS file should define a variable with GeoJSON data
                    // Try to find the variable name from the filename
                    var varName = filename.replace('./layers/', '')
                                          .replace('.js', '')
                                          .replace(/\//g, '_');
                    
                    // Common qgis2web variable patterns
                    var possibleVarNames = [
                        'json_' + varName,
                        varName,
                        'data_' + varName
                    ];
                    
                    // Try each possible variable name
                    var geoJSONData = null;
                    for (var i = 0; i < possibleVarNames.length; i++) {
                        if (window[possibleVarNames[i]]) {
                            geoJSONData = window[possibleVarNames[i]];
                            console.log('Found data in variable:', possibleVarNames[i]);
                            break;
                        }
                    }
                    
                    if (geoJSONData) {
                        // Add to map
                        var layer = L.geoJSON(geoJSONData, {
                            style: {
                                color: color,
                                weight: 2,
                                fillColor: color,
                                fillOpacity: 0.2,
                                opacity: 0.8
                            },
                            onEachFeature: function(feature, layer) {
                                if (feature.properties) {
                                    var popupContent = '<div style="max-width:250px;">';
                                    popupContent += '<b>' + layerName + '</b><br><hr>';
                                    for (var key in feature.properties) {
                                        if (feature.properties[key] && feature.properties[key] !== 'null') {
                                            popupContent += '<b>' + key + ':</b> ' + 
                                                           feature.properties[key] + '<br>';
                                        }
                                    }
                                    popupContent += '</div>';
                                    layer.bindPopup(popupContent);
                                }
                            }
                        }).addTo(map);
                        
                        updateStatus('✓ Loaded: ' + filename);
                        resolve(layer);
                    } else {
                        updateStatus('✗ No data found in: ' + filename);
                        reject(new Error('No GeoJSON data found in JS file'));
                    }
                };
                script.onerror = function() {
                    updateStatus('✗ Failed to load: ' + filename);
                    reject(new Error('Failed to load JS file'));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Status update function
        function updateStatus(message) {
            document.getElementById('file-status').innerHTML += 
                '<div style="margin:5px 0; padding:3px; border-left:3px solid ' + 
                (message.startsWith('✓') ? 'green' : 'orange') + '">' + message + '</div>';
            console.log(message);
        }
        
        // Load all data files
        async function loadAllData() {
            updateStatus('Starting data load...');
            
            // Based on your console errors, these are the files that exist
            const filesToLoad = [
                {
                    filename: './layers/portsports_maroc_coordonnees_qgis_1_9.js',
                    color: '#3388ff',
                    name: 'Ports'
                },
                {
                    filename: './layers/map_10.js',
                    color: '#33aa33', 
                    name: 'Provinces'
                }
            ];
            
            let loadedCount = 0;
            
            for (const file of filesToLoad) {
                try {
                    updateStatus('Loading: ' + file.filename);
                    await loadJSDataFile(file.filename, file.color, file.name);
                    loadedCount++;
                } catch (error) {
                    updateStatus('Error loading ' + file.filename + ': ' + error.message);
                }
            }
            
            // Update final status
            document.getElementById('status').innerHTML = 
                'Loaded ' + loadedCount + ' of ' + filesToLoad.length + ' layers';
            
            if (loadedCount === 0) {
                updateStatus('No layers loaded. Trying alternative method...');
                tryAlternativeMethod();
            }
        }
        
        // Alternative method: Try to parse JS files as text
        function tryAlternativeMethod() {
            updateStatus('Trying to parse JS files as text...');
            
            // Try to load and parse the JS files manually
            fetch('./layers/portsports_maroc_coordonnees_qgis_1_9.js')
                .then(response => response.text())
                .then(jsContent => {
                    console.log('JS file content (first 500 chars):', jsContent.substring(0, 500));
                    
                    // Look for GeoJSON data in the JS file
                    // Common pattern: var json_something = { ... };
                    var jsonMatch = jsContent.match(/var json_[^=]*=\s*(\{.*?\});/s);
                    if (jsonMatch) {
                        updateStatus('Found JSON data in JS file');
                        try {
                            var geoJSON = JSON.parse(jsonMatch[1]);
                            updateStatus('✓ Successfully parsed GeoJSON');
                            // Add to map here
                        } catch (e) {
                            updateStatus('✗ Could not parse JSON: ' + e.message);
                        }
                    } else {
                        updateStatus('No JSON variable found in JS file');
                    }
                })
                .catch(e => updateStatus('Failed to fetch JS file: ' + e.message));
        }
        
        // Start loading when page loads
        window.onload = function() {
            document.getElementById('status').innerHTML = 'Starting data load...';
            setTimeout(loadAllData, 1000);
            
            // Auto-hide loading panel after 10 seconds
            setTimeout(function() {
                document.getElementById('loading').style.opacity = '0.7';
            }, 10000);
        };
        
        // Add map controls
        L.control.scale().addTo(map);
    </script>
</body>
</html>
